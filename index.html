<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Legacy Gift AR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; font-family: sans-serif; overflow: hidden; }
      
      /* 1. THE CINEMA OVERLAY (Hidden by default) */
      #cinema-mode {
        display: none; /* Hidden until target found */
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); /* Dark background to focus attention */
        z-index: 999;
        justify-content: center; align-items: center; flex-direction: column;
      }

      /* 2. THE VIDEO PLAYER (Perfect Fit) */
      #cinema-video {
        width: 90%;             /* Fits width of phone */
        max-width: 600px;       /* Limits size on tablets */
        aspect-ratio: 1 / 1.41; /* FORCES A4 PAPER SHAPE */
        object-fit: contain;    /* Ensures full video is seen */
        box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); /* Gold Glow */
        border: 2px solid #d4af37;
        border-radius: 8px;
        background: black;
      }

      /* 3. CLOSE BUTTON */
      #close-btn {
        margin-top: 20px; padding: 10px 30px;
        background: white; border: none; border-radius: 30px;
        font-weight: bold; cursor: pointer;
      }

      /* 4. SCANNING UI */
      #scan-ui {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 500; pointer-events: none;
        display: flex; justify-content: center; align-items: center;
      }
      .scanner-border {
        width: 70vw; height: 100vw; /* Rough A4 shape */
        border: 2px dashed rgba(255, 255, 255, 0.5);
        border-radius: 10px;
      }
    </style>
  </head>
  <body>

    <div id="scan-ui">
      <div class="scanner-border"></div>
    </div>

    <div id="cinema-mode">
      <video id="cinema-video" playsinline webkit-playsinline controls>
        <source src="./magic-video.mp4" type="video/mp4">
      </video>
      <button id="close-btn">CLOSE & RESCAN</button>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="target-anchor" mindar-image-target="targetIndex: 0"></a-entity>
      
    </a-scene>

    <script>
      const arSystem = document.querySelector('a-scene').systems['mindar-image-system'];
      const targetAnchor = document.querySelector('#target-anchor');
      const cinemaDiv = document.querySelector('#cinema-mode');
      const videoPlayer = document.querySelector('#cinema-video');
      const closeBtn = document.querySelector('#close-btn');
      const scanUI = document.querySelector('#scan-ui');

      // --- LOGIC 1: TARGET FOUND -> STOP TRACKING & PLAY ---
      targetAnchor.addEventListener("targetFound", () => {
        console.log("Found! Locking to screen...");
        
        // 1. Pause the AR Engine (Stops Jitter / Saves Battery)
        // Note: We use a small timeout to ensure the finding triggers
        setTimeout(() => {
           // Hide Scanning UI
           scanUI.style.display = 'none';
           
           // Show Cinema Mode
           cinemaDiv.style.display = 'flex';
           
           // Play Video
           videoPlayer.currentTime = 0;
           videoPlayer.play();
        }, 500);
      });

      // --- LOGIC 2: CLOSE / FINISH -> START TRACKING ---
      
      function resetAR() {
        // Hide Cinema Mode
        cinemaDiv.style.display = 'none';
        videoPlayer.pause();

        // Show Scanning UI
        scanUI.style.display = 'flex';
        
        // We don't actually need to "restart" the engine in A-Frame
        // because we just covered it up. But if you want to force re-scan:
        // The tracking continues in background, so it's ready instantly.
      }

      closeBtn.addEventListener('click', resetAR);
      
      // Auto-close when video ends
      videoPlayer.addEventListener('ended', resetAR);

    </script>
  </body>
</html>
