<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Artivive Clone</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <script>
      // --- THE "ARTIVIVE" PHYSICS ENGINE ---
      // This script creates that "Premium Smoothness" you want.
      // It separates the video from the jittery camera.
      
      AFRAME.registerComponent('artivive-smooth', {
        schema: {
          target: {type: 'selector'},
          friction: {type: 'number', default: 0.1} // 0.1 = Heavy/Smooth, 1.0 = Instant/Jittery
        },
        init: function() {
          this.el.object3D.visible = false;
          this.isPlaying = false;
        },
        tick: function (t, dt) {
          const targetEl = this.data.target;
          const targetObj = targetEl.object3D;
          const myObj = this.el.object3D;

          // 1. VISIBILITY LOGIC (Prevents flickering)
          if (!targetObj.visible) {
             if (this.isPlaying) {
               // If lost, slowly fade out or hide (here we hide for simplicity)
               myObj.visible = false;
             }
             return;
          }
          
          // If found, show it
          myObj.visible = true;

          // 2. THE "BUTTER" MATH (Linear Interpolation)
          // Instead of snapping to position, we "slide" towards it.
          // This kills 100% of the jitter because micro-shakes are ignored.
          
          // Move Position
          myObj.position.lerp(targetObj.position, this.data.friction);
          
          // Move Rotation
          myObj.quaternion.slerp(targetObj.quaternion, this.data.friction);
          
          // Move Scale (If you zoom in/out)
          myObj.scale.lerp(targetObj.scale, this.data.friction);
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; font-family: 'Helvetica', sans-serif; background: black; }
      
      /* UI: START OVERLAY */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 9999;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        transition: opacity 0.5s;
      }
      #start-btn {
        padding: 15px 40px; font-size: 18px; letter-spacing: 2px;
        background: transparent; color: white;
        border: 2px solid white; border-radius: 50px;
        cursor: pointer; text-transform: uppercase;
      }
      
      /* UI: LOADING SPINNER */
      .loader {
        border: 4px solid #f3f3f3; border-top: 4px solid #d4af37;
        border-radius: 50%; width: 30px; height: 30px;
        animation: spin 1s linear infinite; margin-bottom: 20px;
        display: none; /* Hidden by default */
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <div class="loader" id="loader"></div>
      <button id="start-btn">TAP TO START</button>
      <p style="color: #666; font-size: 10px; margin-top: 10px;">POWERED BY WEB-AR</p>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <video id="vid" src="./magic-video.mp4" 
               preload="auto" loop="true" 
               playsinline webkit-playsinline muted 
               crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="target-anchor" mindar-image-target="targetIndex: 0" visible="false"></a-entity>

      <a-entity artivive-smooth="target: #target-anchor; friction: 0.1">
        
        <a-plane 
          src="#vid" 
          width="1" height="1.41" 
          position="0 0 0"
          material="shader: flat; src: #vid; opacity: 1;"
        ></a-plane>

      </a-entity>
      
    </a-scene>

    <script>
      const startBtn = document.querySelector('#start-btn');
      const startScreen = document.querySelector('#start-screen');
      const video = document.querySelector('#vid');
      const loader = document.querySelector('#loader');

      // 1. INITIALIZE (Unlock Audio)
      startBtn.addEventListener('click', () => {
        startBtn.style.display = 'none';
        loader.style.display = 'block';
        
        // Force Video Load
        video.muted = true;
        video.play().then(() => {
           video.pause(); // Pause and wait for target
           startScreen.style.opacity = '0';
           setTimeout(() => { startScreen.style.display = 'none'; }, 500);
        }).catch(e => {
           alert("Error playing video: " + e.message);
        });
      });

      // 2. TARGET FOUND (Fade In Audio)
      const anchor = document.querySelector('#target-anchor');
      anchor.addEventListener("targetFound", () => {
        video.muted = false;
        video.currentTime = 0; // Restart for impact
        video.play();
      });

      // 3. TARGET LOST (Fade Out)
      anchor.addEventListener("targetLost", () => {
        video.pause();
      });
    </script>
  </body>
</html>
