<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Artivive Style WebAR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <script>
      // --- COMPONENT: ARTIVIVE FADE-IN ---
      // This mimics the "Premium" feel. The video doesn't just appear;
      // it fades in smoothly when detected, and fades out slowly when lost.
      AFRAME.registerComponent('fade-in-out', {
        init: function() {
          this.el.setAttribute('material', 'opacity', 0);
          this.el.setAttribute('visible', false);
          this.fadeSpeed = 0.05; // 0.05 = Slow/Premium Fade
        },
        tick: function() {
          const target = document.querySelector('#target-anchor');
          const videoMesh = this.el.getObject3D('mesh');
          if (!videoMesh || !videoMesh.material) return;

          if (target.object3D.visible) {
            // FADE IN
            this.el.setAttribute('visible', true);
            if (videoMesh.material.opacity < 1) {
              videoMesh.material.opacity += this.fadeSpeed;
            }
          } else {
            // FADE OUT (Don't hide immediately, let it linger)
            if (videoMesh.material.opacity > 0) {
              videoMesh.material.opacity -= this.fadeSpeed;
            } else {
              this.el.setAttribute('visible', false);
            }
          }
        }
      });
    </script>

    <style>
      body { margin: 0; background: black; font-family: 'Helvetica Neue', sans-serif; overflow: hidden; }
      
      /* UI: START SCREEN (Artivive Style) */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 9999;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        transition: opacity 0.8s;
      }
      
      #start-btn {
        padding: 16px 40px; font-size: 16px; font-weight: 600; letter-spacing: 2px;
        background: white; color: black;
        border: none; border-radius: 4px;
        cursor: pointer; text-transform: uppercase;
      }
      
      /* UI: SCANNING GUIDE */
      #scan-guide {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; display: flex;
        justify-content: center; align-items: center;
        opacity: 0; transition: opacity 1s;
      }
      .scan-frame {
        width: 70vw; height: 100vw; /* Approx A4 Ratio */
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
      }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" width="80" style="margin-bottom:30px; filter:invert(1);">
      <button id="start-btn">TAP TO START</button>
      <p style="color:#666; font-size:11px; margin-top:20px;">POWERED BY MINDAR</p>
    </div>

    <div id="scan-guide">
      <div class="scan-frame"></div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 10; uiScanning: no; uiLoading: no;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <video id="vid" src="./magic-video.mp4" 
               preload="auto" loop="true" 
               playsinline webkit-playsinline muted 
               crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="target-anchor" mindar-image-target="targetIndex: 0"></a-entity>

      <a-entity id="video-entity" fade-in-out>
        <a-video 
          src="#vid" 
          width="1" height="1.41" 
          position="0 0 0" 
          rotation="0 0 0"
        ></a-video>
      </a-entity>
      
    </a-scene>

    <script>
      const startBtn = document.querySelector('#start-btn');
      const startScreen = document.querySelector('#start-screen');
      const scanGuide = document.querySelector('#scan-guide');
      const video = document.querySelector('#vid');
      const videoEntity = document.querySelector('#video-entity');
      const targetAnchor = document.querySelector('#target-anchor');

      // 1. START EXPERIENCE (Unlock Audio)
      startBtn.addEventListener('click', () => {
        // Fade out start screen
        startScreen.style.opacity = '0';
        setTimeout(() => { startScreen.style.display = 'none'; }, 800);
        
        // Show Scan Guide
        scanGuide.style.opacity = '1';

        // Wake up video engine (Muted first to be safe)
        video.muted = true;
        video.play().then(() => {
          video.pause(); // Pause and wait for tracking
          video.currentTime = 0;
        });
      });

      // 2. TARGET FOUND
      targetAnchor.addEventListener("targetFound", () => {
        console.log("Locked");
        scanGuide.style.opacity = '0.2'; // Dim the guide
        video.muted = false; // Turn on Sound
        video.play();
      });

      // 3. TARGET LOST
      targetAnchor.addEventListener("targetLost", () => {
        console.log("Lost");
        scanGuide.style.opacity = '1'; // Show guide again
        video.pause();
      });
    </script>
  </body>
</html>
